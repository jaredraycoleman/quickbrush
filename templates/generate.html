{% extends "base.html" %}
{% block content %}
<div class="wispy-frame">
  <div class="d-flex justify-content-between align-items-center mb-4">
    <h3 class="mb-0">
      <img src="{{ url_for('static', filename='images/paintbrush.webp') }}"
           alt="Brush Icon" style="width:22px; height:22px; vertical-align:middle; margin-right:6px;">
      Create with Quickbrush
    </h3>
    <a href="{{ url_for('dashboard') }}" class="btn btn-sm btn-outline-secondary">
      Back to Dashboard
    </a>
  </div>

<form id="generate-form" method="post" enctype="multipart/form-data" novalidate>
  <div class="mb-3">
    <label for="gen_type" class="form-label fw-bold">What do you want to paint?</label>
    <select class="form-select" name="gen_type" id="gen_type">
      <option value="character" {% if gen_type == 'character' %}selected{% endif %}>🎭 Character</option>
      <option value="scene" {% if gen_type == 'scene' %}selected{% endif %}>🌄 Scene</option>
      <option value="creature" {% if gen_type == 'creature' %}selected{% endif %}>🐉 Creature</option>
      <option value="item" {% if gen_type == 'item' %}selected{% endif %}>🗡️ Item</option>
    </select>
    <div class="form-text">
      Choose what kind of image you’re summoning — a portrait, a landscape, a monster, or an artifact!
    </div>
  </div>

  <div class="mb-3">
    <label for="text" class="form-label fw-bold">Description <span class="text-danger">*</span></label>
    <textarea class="form-control {% if error and not text %}is-invalid{% endif %}"
              id="text" name="text" rows="3" required
              placeholder="Describe your subject — Wispy loves detail!">{{ text or '' }}</textarea>
    <div class="form-text">
      This is the base — what your subject looks like or what the scene contains.
    </div>
    {% if error and not text %}
    <div class="invalid-feedback">
      Please provide a description for your image.
    </div>
    {% endif %}
  </div>

  <div class="mb-3">
    <label for="prompt" class="form-label fw-bold">Artistic Prompt</label>
    <textarea class="form-control" id="prompt" name="prompt" rows="2"
      placeholder="e.g., in golden light, wearing a cloak, in a misty forest.">{{ prompt or '' }}</textarea>
    <div class="form-text">
      Add mood, pose, or details that shape how Wispy paints.
    </div>
  </div>

  <div class="mb-3">
    <label for="reference_images" class="form-label fw-bold">Reference Images (optional)</label>
    <input class="form-control" type="file" name="reference_images" id="reference_images" accept="image/*" multiple>
    <div class="form-text">Up to 3 images. Wispy uses them for inspiration.</div>
  </div>

  <div class="mb-3">
    <label for="quality" class="form-label fw-bold">Quality</label>
    <select class="form-select" name="quality" id="quality">
      <option value="low" {% if quality == 'low' %}selected{% endif %}>Low (1 brushstroke — quick sketch)</option>
      <option value="medium" {% if quality == 'medium' %}selected{% endif %}>Medium (3 brushstrokes — refined)</option>
      <option value="high" {% if quality == 'high' %}selected{% endif %}>High (5 brushstrokes — masterpiece)</option>
    </select>
    <div class="form-text">Higher quality = more detail, more brushstrokes.</div>
  </div>

  <div class="d-flex gap-2 align-items-center mt-3">
    <button type="submit" id="generate-btn" class="btn btn-wispy">
      <span id="btn-text">Generate Image</span>
    </button>
    <div id="loading" class="text-muted" style="display:none;">
      <div class="spinner-border spinner-border-sm text-secondary" role="status"></div>
      <span class="ms-2">Wispy is painting your masterpiece...</span>
    </div>
  </div>
</form>

{% if generated_image_id %}
<hr class="my-4">
<div class="card border-success">
  <div class="card-header bg-success text-white">
    <h5 class="mb-0">✨ Your Generated Image</h5>
  </div>
  <div class="card-body">
    <div class="alert alert-info mb-3">
      <i class="bi bi-info-circle"></i> Images are stored as WebP format and limited to your last 100 generations.
      <a href="{{ url_for('library') }}" class="alert-link">View all images in your library</a>
    </div>
    {% if description %}
    <div class="alert alert-light mb-3">
      <small class="text-muted"><strong>AI Description:</strong></small><br>
      <small>{{ description }}</small>
    </div>
    {% endif %}
    <div class="text-center">
      <img src="{{ url_for('serve_image', generation_id=generated_image_id) }}" alt="Generated Image"
           class="img-fluid rounded shadow-sm mb-3"
           style="max-width:100%; height:auto; max-height:600px;">
      <br>
      <div class="d-flex gap-2 justify-content-center flex-wrap">
        <a href="{{ url_for('serve_image', generation_id=generated_image_id) }}" download="generated_image.webp" class="btn btn-outline-dark">
          <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-download" viewBox="0 0 16 16">
            <path d="M.5 9.9a.5.5 0 0 1 .5.5v2.5a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1v-2.5a.5.5 0 0 1 1 0v2.5a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2v-2.5a.5.5 0 0 1 .5-.5z"/>
            <path d="M7.646 11.854a.5.5 0 0 0 .708 0l3-3a.5.5 0 0 0-.708-.708L8.5 10.293V1.5a.5.5 0 0 0-1 0v8.793L5.354 8.146a.5.5 0 1 0-.708.708l3 3z"/>
          </svg>
          Download (WebP)
        </a>
        <a href="{{ url_for('library') }}" class="btn btn-outline-secondary">
          <i class="bi bi-images"></i> View Library
        </a>
        <button type="button" class="btn btn-wispy" onclick="document.getElementById('generate-form').scrollIntoView({behavior: 'smooth'})">
          Generate Another
        </button>
      </div>
    </div>
  </div>
</div>
{% endif %}

<script>
const form = document.getElementById('generate-form');
const btn = document.getElementById('generate-btn');
const btnText = document.getElementById('btn-text');
const loading = document.getElementById('loading');

// Form validation
form.addEventListener('submit', (e) => {
  const textArea = document.getElementById('text');
  if (!textArea.value.trim()) {
    e.preventDefault();
    textArea.classList.add('is-invalid');
    textArea.focus();
    return false;
  }

  // Show loading state
  btn.disabled = true;
  btnText.innerText = 'Generating...';
  loading.style.display = 'inline-block';
});

// Remove invalid class when user starts typing
document.getElementById('text').addEventListener('input', function() {
  this.classList.remove('is-invalid');
});
</script>

{% endblock %}
