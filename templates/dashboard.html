{% extends "base.html" %}
{% block content %}
<div class="wispy-frame">
  <div class="d-flex align-items-center mb-4">
    <img src="{{ url_for('static', filename='images/wispy.webp') }}" alt="Wispy" class="rounded-circle me-3" style="width: 80px; height: 80px;">
    <div>
      <h3 class="mb-0">Hello, {{ user.email or "Adventurer" }}!</h3>
      <p class="text-muted mb-0">Your brushstrokes await!</p>
    </div>
  </div>

  <!-- Brushstrokes Balance -->
  <div class="card border-0 shadow-sm mb-3">
    <div class="card-body">
      <h5 class="fw-bold">Brushstrokes Balance</h5>
      <p class="mb-1">Total Available: <strong>{{ total_brushstrokes }}</strong> brushstrokes</p>

      <div class="row mt-3">
        {% if subscription %}
        <div class="col-md-6">
          <small class="text-muted">Subscription Allowance:</small>
          <div class="progress" style="height: 25px;">
            <div class="progress-bar bg-success" role="progressbar"
                 style="width: {{ (subscription.allowance_remaining / subscription.monthly_allowance * 100) if subscription.monthly_allowance > 0 else 0 }}%"
                 aria-valuenow="{{ subscription.allowance_remaining }}"
                 aria-valuemin="0"
                 aria-valuemax="{{ subscription.monthly_allowance }}">
              {{ subscription.allowance_remaining }} / {{ subscription.monthly_allowance }}
            </div>
          </div>
        </div>
        {% endif %}

        <div class="col-md-6">
          <small class="text-muted">Purchased Packs:</small>
          <p class="mb-0"><strong>{{ purchased_brushstrokes }}</strong> brushstrokes</p>
          <small class="text-muted">(Never expire)</small>
        </div>
      </div>

      {% if total_brushstrokes < 10 %}
      <div class="alert alert-warning py-2 px-3 mt-3 mb-0">
        <small>‚ö†Ô∏è Low on brushstrokes! Subscribe or purchase a pack below.</small>
      </div>
      {% endif %}
    </div>
  </div>

  <!-- Subscription Section -->
  <div class="card border-0 shadow-sm mb-3">
    <div class="card-body">
      <h5 class="fw-bold">Subscription</h5>

      {% if subscription and subscription.status == 'active' %}
        <div class="d-flex justify-content-between align-items-center mb-2">
          <div>
            <span class="badge bg-success">{{ subscription.tier|title }} Plan</span>
            <p class="mb-0 mt-2 text-muted small">
              {{ subscription.monthly_allowance }} brushstrokes per month
            </p>
            {% if subscription.current_period_end %}
            <p class="mb-0 text-muted small">
              {% if subscription.cancel_at_period_end %}
                Cancels on {{ subscription.current_period_end.strftime('%B %d, %Y') }}
              {% else %}
                Renews {{ subscription.current_period_end.strftime('%B %d, %Y') }}
              {% endif %}
            </p>
            {% endif %}
          </div>

          <div>
            <a href="{{ url_for('portal') }}" class="btn btn-primary">
              <i class="bi bi-gear"></i> Manage Subscription
            </a>
          </div>
        </div>

        <p class="text-muted small mt-2">
          Use the Customer Portal to upgrade, downgrade, or cancel your subscription.
        </p>

      {% else %}
        <p class="text-muted mb-3">Subscribe for the best value ‚Äî get monthly brushstroke allowances at half the cost!</p>

        <a href="{{ url_for('portal') }}" class="btn btn-primary btn-lg">
          <i class="bi bi-gear"></i> Manage Subscription
        </a>

        <p class="text-muted mt-2">
          Choose from: Basic ($5/mo, 250), Pro ($10/mo, 500), Premium ($20/mo, 1000), or Ultimate ($50/mo, 5000 brushstrokes)
        </p>

        <button class="btn btn-sm btn-link mt-2" data-bs-toggle="modal" data-bs-target="#pricingModal">
          Learn more about subscriptions
        </button>
      {% endif %}
    </div>
  </div>

  <!-- Purchase Packs Section -->
  <div class="card border-0 shadow-sm mb-3">
    <div class="card-body">
      <h5 class="fw-bold">Purchase Brushstroke Packs</h5>
      <p class="text-muted mb-3">One-time purchases that never expire ($0.04 per brushstroke)</p>

      <div class="row g-2">
        <div class="col-6 col-md-3">
          <a href="{{ url_for('buy_pack', price_id=stripe_prices.pack_250) }}" class="btn btn-outline-secondary w-100">
            <strong>Small</strong><br>
            <small>$10</small><br>
            <small class="text-muted">250 brushstrokes</small>
          </a>
        </div>
        <div class="col-6 col-md-3">
          <a href="{{ url_for('buy_pack', price_id=stripe_prices.pack_500) }}" class="btn btn-outline-secondary w-100">
            <strong>Medium</strong><br>
            <small>$20</small><br>
            <small class="text-muted">500 brushstrokes</small>
          </a>
        </div>
        <div class="col-6 col-md-3">
          <a href="{{ url_for('buy_pack', price_id=stripe_prices.pack_1000) }}" class="btn btn-outline-secondary w-100">
            <strong>Large</strong><br>
            <small>$40</small><br>
            <small class="text-muted">1000 brushstrokes</small>
          </a>
        </div>
        <div class="col-6 col-md-3">
          <a href="{{ url_for('buy_pack', price_id=stripe_prices.pack_5000) }}" class="btn btn-outline-secondary w-100">
            <strong>Mega</strong><br>
            <small>$200</small><br>
            <small class="text-muted">5000 brushstrokes</small>
          </a>
        </div>
      </div>
    </div>
  </div>

  <!-- API Keys Section -->
  <div class="card border-0 shadow-sm mb-3">
    <div class="card-body">
      <h5 class="fw-bold">API Access</h5>
      <p class="text-muted mb-2">Generate images programmatically with our REST API</p>

      {% if api_keys %}
      <p class="mb-2"><small>You have {{ api_keys|length }} active API key(s)</small></p>
      {% endif %}

      <div class="d-flex gap-2">
        <a href="{{ url_for('api_keys_page') }}" class="btn btn-sm btn-outline-secondary">Manage API Keys</a>
        <a href="/api/docs" target="_blank" class="btn btn-sm btn-outline-secondary">API Documentation</a>
      </div>
    </div>
  </div>

  <!-- Action Buttons -->
  <div class="d-flex gap-2">
    <a href="{{ url_for('generate') }}" class="btn btn-wispy">Generate an Image</a>
    <a href="{{ url_for('portal') }}" class="btn btn-outline-dark">Billing Portal</a>
  </div>
</div>


<!-- Pricing Modal -->
<div class="modal fade" id="pricingModal" tabindex="-1" aria-labelledby="pricingModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header bg-light">
        <h5 class="modal-title" id="pricingModalLabel">Quickbrush Pricing Guide</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <h6 class="fw-bold">‚ú® How Brushstrokes Work</h6>
        <p>Every image you generate costs a few brushstrokes depending on its quality:</p>
        <ul>
          <li><strong>1 brushstroke</strong> ‚Äî Low Quality (quick sketch)</li>
          <li><strong>3 brushstrokes</strong> ‚Äî Medium Quality (refined detail)</li>
          <li><strong>5 brushstrokes</strong> ‚Äî High Quality (fully rendered masterpiece)</li>
        </ul>

        <hr>

        <h6 class="fw-bold">üìÖ Subscription Plans (Best Value!)</h6>
        <p>Get monthly brushstroke allowances at <strong>$0.02 per brushstroke</strong>:</p>
        <ul>
          <li><strong>Basic ($5/mo)</strong> ‚Äî 250 brushstrokes/month</li>
          <li><strong>Pro ($10/mo)</strong> ‚Äî 500 brushstrokes/month</li>
          <li><strong>Premium ($20/mo)</strong> ‚Äî 1000 brushstrokes/month</li>
          <li><strong>Ultimate ($50/mo)</strong> ‚Äî 5000 brushstrokes/month</li>
        </ul>
        <p class="text-muted small">Allowances reset each billing cycle. Use subscription brushstrokes first, then purchased packs.</p>

        <hr>

        <h6 class="fw-bold">üí∞ One-Time Packs</h6>
        <p>Purchase brushstrokes that never expire at <strong>$0.04 per brushstroke</strong>:</p>
        <ul>
          <li><strong>$10</strong> ‚Äî 250 brushstrokes</li>
          <li><strong>$20</strong> ‚Äî 500 brushstrokes</li>
          <li><strong>$40</strong> ‚Äî 1000 brushstrokes</li>
          <li><strong>$200</strong> ‚Äî 5000 brushstrokes</li>
        </ul>
        <p class="text-muted small">Perfect for occasional use or supplementing your subscription.</p>

        <hr>

        <h6 class="fw-bold">üéØ Which Option is Right for You?</h6>
        <ul>
          <li><strong>Subscribe</strong> if you generate images regularly (best value at 50% savings!)</li>
          <li><strong>Buy packs</strong> if you only create occasionally or want a reserve</li>
          <li><strong>Do both!</strong> Subscribe for monthly use, buy packs for extra when needed</li>
        </ul>

        <p class="text-muted mt-3">
          <em>Your subscription allowance is used first each month, then any purchased packs kick in automatically.</em>
        </p>
      </div>
    </div>
  </div>
</div>

{% endblock %}
