<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Generate - Quickbrush</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css">
  <link href="https://fonts.googleapis.com/css2?family=Marcellus+SC&family=Raleway:wght@400;600&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="css/style.css">
  <link rel="icon" type="image/x-icon" href="images/wispy.ico">
  <style>
    .generation-preview {
      max-width: 100%;
      border-radius: 8px;
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    }
    .reference-image-preview {
      max-width: 100px;
      max-height: 100px;
      object-fit: cover;
      border-radius: 4px;
      border: 2px solid #dee2e6;
    }
    .spinner-border-sm {
      width: 1rem;
      height: 1rem;
    }
    #generationProgress {
      display: none;
    }
  </style>
</head>
<body>
<div class="main-content">
  <nav class="navbar navbar-expand-lg navbar-dark">
    <div class="container">
      <a class="navbar-brand" href="index.html">
        <i class="bi bi-brush-fill"></i> Quickbrush
      </a>
      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
        <span class="navbar-toggler-icon"></span>
      </button>
      <div class="collapse navbar-collapse" id="navbarNav">
        <ul class="navbar-nav me-auto">
          <li class="nav-item">
            <a class="nav-link" href="showcase.html">
              <i class="bi bi-stars"></i> Showcase
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link active" href="generate.html">
              <i class="bi bi-palette-fill"></i> Generate
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="library.html">
              <i class="bi bi-images"></i> Library
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="ai-and-artists.html">
              <i class="bi bi-heart"></i> AI & Artists
            </a>
          </li>
        </ul>
      </div>
    </div>
  </nav>

  <div class="container mt-5 mb-5">
    <div class="row justify-content-center">
      <div class="col-lg-10">
        <div class="text-center mb-4">
          <h1 class="display-5 fw-bold mb-3">
            <i class="bi bi-palette-fill text-primary"></i> Generate Images
          </h1>
          <p class="lead text-muted">Create fantasy RPG artwork using your OpenAI API key</p>
        </div>

        <!-- API Key Configuration -->
        <div class="card shadow-sm mb-4" id="apiKeyCard">
          <div class="card-body">
            <h5 class="card-title"><i class="bi bi-key"></i> API Key Configuration</h5>
            <div class="mb-3">
              <label for="apiKey" class="form-label">OpenAI API Key</label>
              <div class="input-group">
                <input type="password" class="form-control" id="apiKey"
                       placeholder="sk-...">
                <button class="btn btn-outline-secondary" type="button" id="toggleApiKey">
                  <i class="bi bi-eye"></i>
                </button>
                <button class="btn btn-primary" type="button" id="saveApiKey">
                  <i class="bi bi-check2"></i> Save
                </button>
              </div>
              <small class="form-text text-muted">
                Your API key is stored locally in your browser and never sent to our servers.
                Get your key from <a href="https://platform.openai.com/api-keys" target="_blank">OpenAI</a>.
              </small>
            </div>
            <div class="alert alert-success d-none" id="apiKeyStatus">
              <i class="bi bi-check-circle"></i> API key configured
            </div>
          </div>
        </div>

        <!-- Generation Form -->
        <div class="card shadow-sm mb-4">
          <div class="card-body">
            <h5 class="card-title"><i class="bi bi-stars"></i> Create Your Image</h5>

            <form id="generateForm">
              <!-- Generation Type -->
              <div class="mb-3">
                <label for="generationType" class="form-label">Type</label>
                <select class="form-select" id="generationType" required>
                  <option value="character">Character</option>
                  <option value="scene">Scene</option>
                  <option value="creature">Creature</option>
                  <option value="item">Item</option>
                </select>
              </div>

              <!-- Description -->
              <div class="mb-3">
                <label for="description" class="form-label">Description</label>
                <textarea class="form-control" id="description" rows="4" required
                          placeholder="Describe what you want to generate..."></textarea>
                <small class="form-text text-muted">
                  Long-form text (e.g., journal entry, character background) that may contain irrelevant details. Focus will be on physical description.
                </small>
              </div>

              <!-- Context Prompt (Optional) -->
              <div class="mb-3">
                <label for="contextPrompt" class="form-label">
                  Context Prompt <span class="text-muted">(optional)</span>
                </label>
                <input type="text" class="form-control" id="contextPrompt"
                       placeholder="e.g., 'wearing a red cloak', 'in a defensive stance', 'at sunset'">
                <small class="form-text text-muted">
                  Specific instructions about what to focus on. This takes priority over the description above.
                </small>
              </div>

              <!-- Model Selection -->
              <div class="mb-3">
                <label for="model" class="form-label">Model</label>
                <select class="form-select" id="model">
                  <option value="gpt-image-1-mini" selected>GPT-Image-1-Mini (Faster, Cheaper)</option>
                  <option value="gpt-image-1">GPT-Image-1 (Higher Quality)</option>
                </select>
              </div>

              <!-- Quality -->
              <div class="mb-3">
                <label for="quality" class="form-label">Quality</label>
                <select class="form-select" id="quality">
                  <option value="low">Low (Standard)</option>
                  <option value="medium">Medium (Good)</option>
                  <option value="high" selected>High (Best)</option>
                </select>
              </div>

              <!-- Aspect Ratio -->
              <div class="mb-3">
                <label for="aspectRatio" class="form-label">Aspect Ratio</label>
                <select class="form-select" id="aspectRatio">
                  <option value="square" selected>Square (1024x1024)</option>
                  <option value="landscape">Landscape (1536x1024)</option>
                  <option value="portrait">Portrait (1024x1536)</option>
                </select>
              </div>

              <!-- Reference Images -->
              <div class="mb-3">
                <label for="referenceImages" class="form-label">
                  Reference Images <span class="text-muted">(optional)</span>
                </label>
                <input type="file" class="form-control" id="referenceImages"
                       accept="image/*" multiple>
                <small class="form-text text-muted">
                  Upload up to 3 reference images to guide composition, style, and visual elements. Supported by GPT-Image-1 and GPT-Image-1-Mini.
                </small>
                <div id="referencePreview" class="mt-2 d-flex gap-2 flex-wrap"></div>
              </div>

              <!-- Progress -->
              <div id="generationProgress" class="mb-3">
                <div class="alert alert-info">
                  <div class="d-flex align-items-center">
                    <div class="spinner-border spinner-border-sm me-2" role="status">
                      <span class="visually-hidden">Loading...</span>
                    </div>
                    <span id="progressText">Preparing...</span>
                  </div>
                </div>
              </div>

              <!-- Submit Button -->
              <button type="submit" class="btn btn-primary btn-lg w-100" id="generateBtn">
                <i class="bi bi-stars"></i> Generate Image
              </button>
            </form>
          </div>
        </div>

        <!-- Result -->
        <div class="card shadow-sm d-none" id="resultCard">
          <div class="card-body">
            <h5 class="card-title"><i class="bi bi-image"></i> Generated Image</h5>
            <div class="text-center">
              <img id="generatedImage" class="generation-preview mb-3" alt="Generated image">
              <div class="d-flex gap-2 justify-content-center">
                <button class="btn btn-success" id="downloadBtn">
                  <i class="bi bi-download"></i> Download
                </button>
                <button class="btn btn-primary" id="saveToLibraryBtn">
                  <i class="bi bi-bookmark"></i> Save to Library
                </button>
                <button class="btn btn-outline-secondary" id="newGenerationBtn">
                  <i class="bi bi-arrow-clockwise"></i> Generate Another
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Footer -->
<footer class="bg-light border-top py-3">
  <div class="container">
    <div class="row">
      <div class="col-md-6 text-center text-md-start mb-2 mb-md-0">
        <small class="text-muted">
          &copy; 2025 <a href="https://wizzlethorpe.com" class="text-muted text-decoration-none">Wizzlethorpe Labs</a>. Quickbrush is a Wizzlethorpe Labs product.
        </small>
      </div>
      <div class="col-md-6 text-center text-md-end">
        <small>
          <a href="privacy.html" class="text-muted text-decoration-none me-3">Privacy Policy</a>
          <a href="terms.html" class="text-muted text-decoration-none me-3">Terms & Conditions</a>
          <a href="ai-and-artists.html" class="text-muted text-decoration-none me-3">AI & Artists</a>
        </small>
      </div>
    </div>
  </div>
</footer>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script src="js/quickbrush-core.js"></script>
<script>
  // API Key Management
  const API_KEY_STORAGE = 'quickbrush_openai_api_key';

  function loadApiKey() {
    const apiKey = localStorage.getItem(API_KEY_STORAGE);
    if (apiKey) {
      document.getElementById('apiKey').value = apiKey;
      document.getElementById('apiKeyStatus').classList.remove('d-none');
    }
    return apiKey;
  }

  function saveApiKey() {
    const apiKey = document.getElementById('apiKey').value.trim();
    if (!apiKey) {
      alert('Please enter an API key');
      return;
    }
    localStorage.setItem(API_KEY_STORAGE, apiKey);
    document.getElementById('apiKeyStatus').classList.remove('d-none');
    alert('API key saved securely in your browser');
  }

  // Toggle API key visibility
  document.getElementById('toggleApiKey').addEventListener('click', () => {
    const input = document.getElementById('apiKey');
    const icon = document.querySelector('#toggleApiKey i');
    if (input.type === 'password') {
      input.type = 'text';
      icon.classList.remove('bi-eye');
      icon.classList.add('bi-eye-slash');
    } else {
      input.type = 'password';
      icon.classList.remove('bi-eye-slash');
      icon.classList.add('bi-eye');
    }
  });

  document.getElementById('saveApiKey').addEventListener('click', saveApiKey);

  // Reference image preview
  document.getElementById('referenceImages').addEventListener('change', (e) => {
    const preview = document.getElementById('referencePreview');
    preview.innerHTML = '';

    Array.from(e.target.files).forEach(file => {
      const reader = new FileReader();
      reader.onload = (event) => {
        const img = document.createElement('img');
        img.src = event.target.result;
        img.className = 'reference-image-preview';
        preview.appendChild(img);
      };
      reader.readAsDataURL(file);
    });
  });

  // Form submission
  document.getElementById('generateForm').addEventListener('submit', async (e) => {
    e.preventDefault();

    const apiKey = loadApiKey();
    if (!apiKey) {
      alert('Please configure your OpenAI API key first');
      document.getElementById('apiKey').focus();
      return;
    }

    // Get form data
    const generationType = document.getElementById('generationType').value;
    const description = document.getElementById('description').value;
    const contextPrompt = document.getElementById('contextPrompt').value.trim() || null;
    const model = document.getElementById('model').value;
    const quality = document.getElementById('quality').value;
    const aspectRatio = document.getElementById('aspectRatio').value;
    const referenceFiles = document.getElementById('referenceImages').files;

    // Show progress
    const progressDiv = document.getElementById('generationProgress');
    const progressText = document.getElementById('progressText');
    const generateBtn = document.getElementById('generateBtn');
    const resultCard = document.getElementById('resultCard');

    progressDiv.style.display = 'block';
    generateBtn.disabled = true;
    resultCard.classList.add('d-none');

    try {
      // Process reference images
      progressText.textContent = 'Processing reference images...';
      const referenceImages = [];
      for (let file of referenceFiles) {
        const base64 = await fileToBase64(file);
        referenceImages.push(base64);
      }

      // Create OpenAI client and generator
      const client = new QuickbrushCore.OpenAIClient(apiKey);
      const generator = QuickbrushCore.createGenerator(generationType, client);

      // Step 1: Refine description
      progressText.textContent = 'Step 1/2: Refining description with GPT-4o...';
      const refinedDescription = await generator.getDescription(description, contextPrompt, referenceImages);
      console.log('Refined description:', refinedDescription);

      // Step 2: Generate image
      progressText.textContent = 'Step 2/2: Generating image...';
      const imageBlob = await generator.generateImage({
        description: refinedDescription.text,
        referenceImages,
        model,
        quality,
        aspectRatio
      });

      // Display result
      progressDiv.style.display = 'none';
      generateBtn.disabled = false;

      const imageUrl = URL.createObjectURL(imageBlob);
      document.getElementById('generatedImage').src = imageUrl;
      resultCard.classList.remove('d-none');

      // Store for download/save
      window.lastGeneratedImage = {
        blob: imageBlob,
        url: imageUrl,
        description: refinedDescription.text,
        type: generationType,
        timestamp: new Date().toISOString()
      };

      // Scroll to result
      resultCard.scrollIntoView({ behavior: 'smooth' });

    } catch (error) {
      console.error('Generation error:', error);
      progressDiv.style.display = 'none';
      generateBtn.disabled = false;
      alert(`Error generating image: ${error.message}`);
    }
  });

  // Download button
  document.getElementById('downloadBtn').addEventListener('click', () => {
    if (!window.lastGeneratedImage) return;

    const a = document.createElement('a');
    a.href = window.lastGeneratedImage.url;
    a.download = `quickbrush-${window.lastGeneratedImage.type}-${Date.now()}.png`;
    a.click();
  });

  // Save to library button
  document.getElementById('saveToLibraryBtn').addEventListener('click', async () => {
    if (!window.lastGeneratedImage) return;

    try {
      // Save to IndexedDB
      await saveToLibrary(window.lastGeneratedImage);
      alert('Image saved to your library!');
    } catch (error) {
      console.error('Error saving to library:', error);
      alert('Error saving to library: ' + error.message);
    }
  });

  // New generation button
  document.getElementById('newGenerationBtn').addEventListener('click', () => {
    document.getElementById('resultCard').classList.add('d-none');
    document.getElementById('generateForm').scrollIntoView({ behavior: 'smooth' });
  });

  // Utility function to convert file to base64
  function fileToBase64(file) {
    return new Promise((resolve, reject) => {
      const reader = new FileReader();
      reader.onload = () => {
        const base64 = reader.result.split(',')[1];
        resolve(base64);
      };
      reader.onerror = reject;
      reader.readAsDataURL(file);
    });
  }

  // IndexedDB library functions
  let db;
  function openDatabase() {
    return new Promise((resolve, reject) => {
      const request = indexedDB.open('QuickbrushLibrary', 1);

      request.onerror = () => reject(request.error);
      request.onsuccess = () => resolve(request.result);

      request.onupgradeneeded = (event) => {
        const db = event.target.result;
        if (!db.objectStoreNames.contains('images')) {
          const objectStore = db.createObjectStore('images', { keyPath: 'id', autoIncrement: true });
          objectStore.createIndex('timestamp', 'timestamp', { unique: false });
          objectStore.createIndex('type', 'type', { unique: false });
        }
      };
    });
  }

  async function saveToLibrary(imageData) {
    if (!db) {
      db = await openDatabase();
    }

    return new Promise((resolve, reject) => {
      const transaction = db.transaction(['images'], 'readwrite');
      const objectStore = transaction.objectStore('images');

      const request = objectStore.add({
        blob: imageData.blob,
        description: imageData.description,
        type: imageData.type,
        timestamp: imageData.timestamp
      });

      request.onsuccess = () => resolve(request.result);
      request.onerror = () => reject(request.error);
    });
  }

  // Initialize
  loadApiKey();
</script>
</body>
</html>
