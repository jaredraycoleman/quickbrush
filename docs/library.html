<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Library - Quickbrush</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css">
  <link href="https://fonts.googleapis.com/css2?family=Marcellus+SC&family=Raleway:wght@400;600&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="css/style.css">
  <link rel="icon" type="image/x-icon" href="images/paintbrush.ico">
  <style>
    .library-image {
      width: 100%;
      height: 250px;
      object-fit: cover;
      border-radius: 8px;
      cursor: pointer;
      transition: transform 0.2s;
    }
    .library-image:hover {
      transform: scale(1.05);
    }
    .library-card {
      position: relative;
    }
    .delete-btn {
      position: absolute;
      top: 10px;
      right: 10px;
      z-index: 10;
    }
  </style>
</head>
<body>
<div class="main-content">
  <nav class="navbar navbar-expand-lg navbar-dark">
    <div class="container">
      <a class="navbar-brand" href="index.html">
        <i class="bi bi-brush-fill"></i> Quickbrush
      </a>
      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
        <span class="navbar-toggler-icon"></span>
      </button>
      <div class="collapse navbar-collapse" id="navbarNav">
        <ul class="navbar-nav me-auto">
          <li class="nav-item">
            <a class="nav-link" href="showcase.html">
              <i class="bi bi-stars"></i> Showcase
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="generate.html">
              <i class="bi bi-palette-fill"></i> Generate
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link active" href="library.html">
              <i class="bi bi-images"></i> Library
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="ai-and-artists.html">
              <i class="bi bi-heart"></i> AI & Artists
            </a>
          </li>
        </ul>
      </div>
    </div>
  </nav>

  <div class="container mt-5 mb-5">
    <div class="row justify-content-center">
      <div class="col-lg-12">
        <div class="text-center mb-4">
          <h1 class="display-5 fw-bold mb-3">
            <i class="bi bi-images text-primary"></i> Your Library
          </h1>
          <p class="lead text-muted">Your locally stored generated images (IndexedDB)</p>
        </div>

        <!-- Empty State -->
        <div id="emptyState" class="text-center py-5 d-none">
          <i class="bi bi-inbox" style="font-size: 4rem; color: #ccc;"></i>
          <p class="lead mt-3">Empty library</p>
          <a href="generate.html" class="btn btn-primary">
            <i class="bi bi-stars"></i> Generate Your First Image
          </a>
        </div>

        <!-- Filter and Actions -->
        <div class="card shadow-sm mb-4" id="controlsCard">
          <div class="card-body">
            <div class="row">
              <div class="col-md-6 mb-3 mb-md-0">
                <label for="filterType" class="form-label">Type Filter</label>
                <select class="form-select" id="filterType">
                  <option value="all">All Types</option>
                  <option value="character">Characters</option>
                  <option value="scene">Scenes</option>
                  <option value="creature">Creatures</option>
                  <option value="item">Items</option>
                </select>
              </div>
              <div class="col-md-6">
                <label class="form-label d-block">&nbsp;</label>
                <button class="btn btn-danger" id="clearAllBtn">
                  <i class="bi bi-trash"></i> Clear All
                </button>
                <button class="btn btn-primary" id="exportAllBtn">
                  <i class="bi bi-download"></i> Export All
                </button>
              </div>
            </div>
          </div>
        </div>

        <!-- Library Grid -->
        <div id="libraryGrid" class="row g-4">
          <!-- Images will be loaded here -->
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Footer -->
<footer class="bg-light border-top py-3">
  <div class="container">
    <div class="row">
      <div class="col-md-6 text-center text-md-start mb-2 mb-md-0">
        <small class="text-muted">
          &copy; 2025 <a href="https://wizzlethorpe.com" class="text-muted text-decoration-none">Wizzlethorpe Labs</a>. Quickbrush is a Wizzlethorpe Labs product.
        </small>
      </div>
      <div class="col-md-6 text-center text-md-end">
        <small>
          <a href="privacy.html" class="text-muted text-decoration-none me-3">Privacy Policy</a>
          <a href="terms.html" class="text-muted text-decoration-none me-3">Terms & Conditions</a>
          <a href="ai-and-artists.html" class="text-muted text-decoration-none me-3">AI & Artists</a>
        </small>
      </div>
    </div>
  </div>
</footer>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
  let db;

  // Open IndexedDB
  function openDatabase() {
    return new Promise((resolve, reject) => {
      const request = indexedDB.open('QuickbrushLibrary', 1);

      request.onerror = () => reject(request.error);
      request.onsuccess = () => resolve(request.result);

      request.onupgradeneeded = (event) => {
        const db = event.target.result;
        if (!db.objectStoreNames.contains('images')) {
          const objectStore = db.createObjectStore('images', { keyPath: 'id', autoIncrement: true });
          objectStore.createIndex('timestamp', 'timestamp', { unique: false });
          objectStore.createIndex('type', 'type', { unique: false });
        }
      };
    });
  }

  // Load all images from library
  async function loadLibrary(filterType = 'all') {
    if (!db) {
      db = await openDatabase();
    }

    return new Promise((resolve, reject) => {
      const transaction = db.transaction(['images'], 'readonly');
      const objectStore = transaction.objectStore('images');
      const request = objectStore.getAll();

      request.onsuccess = () => {
        let images = request.result;
        if (filterType !== 'all') {
          images = images.filter(img => img.type === filterType);
        }
        // Sort by timestamp (newest first)
        images.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
        resolve(images);
      };
      request.onerror = () => reject(request.error);
    });
  }

  // Delete image from library
  async function deleteImage(id) {
    if (!db) {
      db = await openDatabase();
    }

    return new Promise((resolve, reject) => {
      const transaction = db.transaction(['images'], 'readwrite');
      const objectStore = transaction.objectStore('images');
      const request = objectStore.delete(id);

      request.onsuccess = () => resolve();
      request.onerror = () => reject(request.error);
    });
  }

  // Clear all images
  async function clearAll() {
    if (!confirm('Are you sure you want to delete all images? This cannot be undone.')) {
      return;
    }

    if (!db) {
      db = await openDatabase();
    }

    return new Promise((resolve, reject) => {
      const transaction = db.transaction(['images'], 'readwrite');
      const objectStore = transaction.objectStore('images');
      const request = objectStore.clear();

      request.onsuccess = () => resolve();
      request.onerror = () => reject(request.error);
    });
  }

  // Display images in grid
  function displayImages(images) {
    const grid = document.getElementById('libraryGrid');
    const emptyState = document.getElementById('emptyState');
    const controlsCard = document.getElementById('controlsCard');

    if (images.length === 0) {
      emptyState.classList.remove('d-none');
      controlsCard.classList.add('d-none');
      grid.innerHTML = '';
      return;
    }

    emptyState.classList.add('d-none');
    controlsCard.classList.remove('d-none');
    grid.innerHTML = '';

    images.forEach(image => {
      const col = document.createElement('div');
      col.className = 'col-md-4 col-lg-3';

      const imageUrl = URL.createObjectURL(image.blob);
      const date = new Date(image.timestamp).toLocaleDateString();
      const typeIcon = {
        character: 'person-circle',
        scene: 'image',
        creature: 'bug',
        item: 'gem'
      }[image.type] || 'image';

      col.innerHTML = `
        <div class="card library-card shadow-sm h-100">
          <button class="btn btn-sm btn-danger delete-btn" data-id="${image.id}">
            <i class="bi bi-trash"></i>
          </button>
          <img src="${imageUrl}" class="library-image" alt="${image.description}" data-id="${image.id}">
          <div class="card-body">
            <p class="card-text small mb-2">
              <i class="bi bi-${typeIcon}"></i> ${image.type.charAt(0).toUpperCase() + image.type.slice(1)}
            </p>
            <p class="card-text small text-muted">${image.description.substring(0, 100)}...</p>
            <p class="card-text small text-muted">${date}</p>
            <div class="d-flex gap-2">
              <button class="btn btn-sm btn-success download-btn" data-id="${image.id}">
                <i class="bi bi-download"></i>
              </button>
            </div>
          </div>
        </div>
      `;

      grid.appendChild(col);
    });

    // Add event listeners
    document.querySelectorAll('.delete-btn').forEach(btn => {
      btn.addEventListener('click', async (e) => {
        e.stopPropagation();
        const id = parseInt(e.currentTarget.dataset.id);
        if (confirm('Delete this image?')) {
          await deleteImage(id);
          refreshLibrary();
        }
      });
    });

    document.querySelectorAll('.download-btn').forEach(btn => {
      btn.addEventListener('click', async (e) => {
        e.stopPropagation();
        const id = parseInt(e.currentTarget.dataset.id);
        const image = images.find(img => img.id === id);
        if (image) {
          const a = document.createElement('a');
          a.href = URL.createObjectURL(image.blob);
          a.download = `quickbrush-${image.type}-${image.id}.png`;
          a.click();
        }
      });
    });

    document.querySelectorAll('.library-image').forEach(img => {
      img.addEventListener('click', (e) => {
        const id = parseInt(e.target.dataset.id);
        const image = images.find(img => img.id === id);
        if (image) {
          // Open in new tab
          const url = URL.createObjectURL(image.blob);
          window.open(url, '_blank');
        }
      });
    });
  }

  // Refresh library display
  async function refreshLibrary() {
    const filterType = document.getElementById('filterType').value;
    const images = await loadLibrary(filterType);
    displayImages(images);
  }

  // Event listeners
  document.getElementById('filterType').addEventListener('change', refreshLibrary);

  document.getElementById('clearAllBtn').addEventListener('click', async () => {
    await clearAll();
    refreshLibrary();
  });

  document.getElementById('exportAllBtn').addEventListener('click', async () => {
    const images = await loadLibrary();
    if (images.length === 0) {
      alert('No images to export');
      return;
    }

    // Download all images as a zip would require a library
    // For now, just download them one by one
    for (let i = 0; i < images.length; i++) {
      const image = images[i];
      const a = document.createElement('a');
      a.href = URL.createObjectURL(image.blob);
      a.download = `quickbrush-${image.type}-${i + 1}.png`;
      a.click();
      // Add delay to avoid browser blocking multiple downloads
      await new Promise(resolve => setTimeout(resolve, 500));
    }
  });

  // Initialize
  refreshLibrary();
</script>
</body>
</html>
